name: Mirror Container Images

on:
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 04:00 UTC
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - images.yml
      - .github/workflows/mirror-images.yml

permissions:
  packages: write

env:
  REGISTRY: ghcr.io/dobbo-ca/mirror

jobs:
  generate-matrix:
    name: Generate matrix
    runs-on:
      group: dobbolab
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate matrix from images.yml
        id: matrix
        run: |
          matrix=$(python3 -c "
          import json, re

          with open('images.yml') as f:
              # Minimal YAML parser for our simple format
              content = f.read()

          images = []
          current = {}
          in_tags = False
          for line in content.split('\n'):
              stripped = line.strip()
              if stripped.startswith('- source:'):
                  if current:
                      images.append(current)
                  current = {'source': stripped.split(':', 1)[1].strip()}
                  in_tags = False
              elif stripped.startswith('name:'):
                  current['name'] = stripped.split(':', 1)[1].strip()
                  in_tags = False
              elif stripped == 'tags:':
                  current['tags'] = []
                  in_tags = True
              elif in_tags and stripped.startswith('- '):
                  current['tags'].append(stripped[2:].strip().strip('\"'))
          if current:
              images.append(current)

          matrix = []
          for img in images:
              for tag in img.get('tags', []):
                  matrix.append({
                      'source': img['source'] + ':' + tag,
                      'name': img['name'],
                      'tag': tag,
                  })

          print(json.dumps({'include': matrix}))
          ")
          echo "matrix=${matrix}" >> "$GITHUB_OUTPUT"

  mirror:
    name: Mirror ${{ matrix.name }}:${{ matrix.tag }}
    needs: generate-matrix
    runs-on:
      group: dobbolab
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Check digests
        id: check
        run: |
          SOURCE="${{ matrix.source }}"
          TARGET="${{ env.REGISTRY }}/${{ matrix.name }}:${{ matrix.tag }}"

          SOURCE_DIGEST=$(crane digest "$SOURCE" 2>&1) && true
          SOURCE_EXIT=$?
          TARGET_DIGEST=$(crane digest "$TARGET" 2>&1) && true
          TARGET_EXIT=$?

          echo "source=$SOURCE_DIGEST" >> "$GITHUB_OUTPUT"
          echo "target=$TARGET_DIGEST" >> "$GITHUB_OUTPUT"

          if [ "$SOURCE_EXIT" -eq 0 ] && [ "$TARGET_EXIT" -eq 0 ] && [ "$SOURCE_DIGEST" = "$TARGET_DIGEST" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Up to date ($SOURCE_DIGEST)"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Needs copy â€” source=$SOURCE_DIGEST target=$TARGET_DIGEST"
          fi

      - name: Copy ${{ matrix.source }}
        if: steps.check.outputs.changed == 'true'
        run: |
          crane copy "${{ matrix.source }}" "${{ env.REGISTRY }}/${{ matrix.name }}:${{ matrix.tag }}"
