name: Mirror Container Images

on:
  schedule:
    - cron: '0 4 * * 0'  # Weekly on Sunday at 04:00 UTC
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - images.yml
      - .github/workflows/mirror-images.yml

permissions:
  packages: write

env:
  REGISTRY: ghcr.io/dobbo-ca/mirror

jobs:
  check:
    name: Check digests
    runs-on:
      group: dobbolab
    outputs:
      matrix: ${{ steps.diff.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Compare source and target digests
        id: diff
        run: |
          REGISTRY="${{ env.REGISTRY }}"

          # Parse images.yml into source:tag pairs
          entries=$(python3 -c "
          import json

          with open('images.yml') as f:
              content = f.read()

          images = []
          current = {}
          in_tags = False
          for line in content.split('\n'):
              stripped = line.strip()
              if stripped.startswith('- source:'):
                  if current:
                      images.append(current)
                  current = {'source': stripped.split(':', 1)[1].strip()}
                  in_tags = False
              elif stripped.startswith('name:'):
                  current['name'] = stripped.split(':', 1)[1].strip()
                  in_tags = False
              elif stripped == 'tags:':
                  current['tags'] = []
                  in_tags = True
              elif in_tags and stripped.startswith('- '):
                  current['tags'].append(stripped[2:].strip().strip('\"'))
          if current:
              images.append(current)

          result = []
          for img in images:
              for tag in img.get('tags', []):
                  result.append({
                      'source': img['source'] + ':' + tag,
                      'name': img['name'],
                      'tag': tag,
                  })
          print(json.dumps(result))
          ")

          changed='[]'
          skipped=0
          total=0

          for row in $(echo "$entries" | jq -c '.[]'); do
            source=$(echo "$row" | jq -r '.source')
            name=$(echo "$row" | jq -r '.name')
            tag=$(echo "$row" | jq -r '.tag')
            target="${REGISTRY}/${name}:${tag}"
            total=$((total + 1))

            source_digest=$(crane digest "$source" 2>/dev/null || echo "MISSING")
            target_digest=$(crane digest "$target" 2>/dev/null || echo "MISSING")

            if [ "$source_digest" != "MISSING" ] && [ "$source_digest" = "$target_digest" ]; then
              echo "✓ ${name}:${tag} — up to date (${source_digest})"
              skipped=$((skipped + 1))
            else
              echo "⬆ ${name}:${tag} — needs copy (source=${source_digest} target=${target_digest})"
              changed=$(echo "$changed" | jq -c --argjson entry "$row" '. + [$entry]')
            fi
          done

          count=$(echo "$changed" | jq 'length')
          echo "Summary: ${count} to copy, ${skipped} up to date, ${total} total"

          matrix=$(echo "$changed" | jq -c '{include: .}')
          echo "matrix=${matrix}" >> "$GITHUB_OUTPUT"

  mirror:
    name: Copy ${{ matrix.name }}:${{ matrix.tag }}
    needs: check
    runs-on:
      group: dobbolab
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}

    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Copy image
        run: crane copy "${{ matrix.source }}" "${{ env.REGISTRY }}/${{ matrix.name }}:${{ matrix.tag }}"
